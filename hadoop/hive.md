# HIVE
하이브는 하둡 기반의 데이터 웨어하우징 프레임워크이다. SQL 로 hdfs 에 저장된 대량의 데이터를 분석할 수 있도록 개발되었다.

일반적으로 하이브는 사용자의 워크스테이션에서 실행되고, 작성된 SQL 쿼리는 일련의 맵리듀스 잡으로 변환되어 하둡 클러스터에서 구동된다. 
하이브는 hdfs 에 저장된 데이터(디렉토리/파일)에 구조(스키마)를 입히는 방식으로 데이터를 테이블로 구조화 시킨다. 
> 테이블 스키마와 같은 메타데이터는 **메타스토어**라는 데이터베이스에 저장된다.

### 메타스토어
메타스토어는 하이브 메타데이터의 핵심 저장소이다. 메타스토어는 서비스와 데이터 보관저장소로 나뉜다.

내장형 메타스토어는 한번에 디스트에 위치한 데이터베이스 파일 하나에만 접근할 수 있다. 
사용자가 동일한 메타 스토어를 공유하는 순간에 단 하나의 하이브 세션만 사용할 수 있기 때문에 
두번째 세션을 시작하면 메타스토어와의 커넥션을 얻기 위한 시도는 실패하고 에러가 발생한다. 

다중 세션을 지원하기 위해서 독립형 데이터베이스를 사용하는 **로컬 메타스토어** 설정 방식을 쓸 수 있다. 
로컬 메타스토어 서비스는 하이브 서비스와 <u>동일한 프로세스</u> 에서 실행되지만,
동일 머신이나 원격 머신에서 별도의 프로세스로 실행되는 데이터 베이스와 연결할 수 있다. 

**원격 메타스토어** 라는 또 다른 메타스토어 설정 방식은 하나 이상의 메타스토어 서버가 하이브 서비스와는 <u>별도의 프로세스</u>로 실행된다. 
원격 메타스토어를 설정해두면 데이터베이스 계층이 방화벽의 역할을 대신하고 따라서 관리성과 보안성이 더 높아질 수 있다. 

## 전통적인 데이터베이스와 비교
하이브는 SQL 인터페이스는 일반적인 데이터베이스와 비슷하다. 하지만,
하이브는 hdfs 와 맵리듀스를 기반으로 개발되었고, 이는 하이브가 제공하는 기능에 직접적으로 영향을 주기 때문에 아키텍처 측면에서 차이가 있을 수 밖에 없다. 

### 읽기 and 쓰기 스키마
전통적인 데이터베이스에서 테이블의 스키마는 데이터를 로드하는 시점에 검증하고, 로드 중인 데이터가 스키마에 부합하지 않으면 해당 데이터를 거부한다. 
> 데이터베이스에 쓰는 시점에 데이터의 스키마를 검증하기 때문에 이런 설계 방식을 **쓰기 스키마** 라고 한다.

하이브는 **읽기 스키마** 방식으로 로드 시점이 아닌 쿼리를 실행하는 시점에서 데이터를 검증한다. 

읽기 스키마는 데이터베이스 내부 형식으로 데이터를 읽거나 파싱하거나 직렬화할 필요가 없기 때문에 초기에 매우 빠른 속도로 데이터를 로드할 수 있다. 
따라서 로드 조작을 위해 단순히 파일을 복사하거나 이동하기만 하면된다. 
쓰기 스키마는 데이터베이스가 컬럼 단위의 데이터 색인과 압축을 제공하기 때문에 더 빠르게 쿼리를 수행할 수 있지만, 상대적으로 데이터베이스에 데이터를 로드하는 시간은 더 오래 걸린다. 
특히 쿼리가 정해지지 않아서 로드 시점에 스키마를 지정할 수 없고 색인도 적용할 수 없는 경우 하이브가 유용할 수 있다. 

### 업데이트
hdfs 는 기존 파일 갱신을 지원하지 않기 때문에 삽입, 변경, 삭제로 인한 갱신 내역은 별도의 작은 델타 파일에 저장된다. 델타 파일은 메타스토어에서 백그라운드로 실행되는 맵리듀스 잡에 의해 기존 테이블과 주기적으로 병합된다.
이 기능은 하이브 트랜잭션 콘텍스트에서만 작동하고, 트랜잭션이 활성화된 테이블에만 적용된다. 
테이블을 읽는 쿼리는 일관된 테이블 스냅샷을 보장받는다. 

### 인덱스
하이브는 맵리듀스를 사용하는 hdfs 에 저장된 데이터를 다루기 때문에 기본 기능은 전체 테이블을 스캔하는 방식으로만 구현되어 있다. 
> 실제 테이블의 갱신은 아예 새로운 테이블을 만들어서 데이터를 변환하는 방식으로 구현된다. 

하지만 하이브는 특정한 경우에 쿼리의 속도를 높일 수 있는 색인을 지원한다. 현재 하이브는 **콤팩트 색인**과 **비트맵 색인**을 지원한다. 
> 색인은 플러그인 방식으로 구현되어 있기 때문에 다른 방식의 색인도 추가 가능하다. 

- 콤팩트 색인: 각 값을 파일 오프셋이 아닌 hdfs 블록 넘버로 저장하기 때문에 디스크 공간을 많이 차지 하지 않으면서 인접한 행 사이에 분포된 
특정 컬럼에 대한 값을 색인하는 데 매우 효율적
- 비트맵 색인: 특정 값이 출현하는 행을 효율적으로 저장하기 위해 압축된 비트셋을 사용. 성별이나 국가 처럼 값의 종류가 적은 컬럼에 적합

